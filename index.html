<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPresensi - Connect</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for PDF, Excel Export, and Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* slate-900 */
            color: #E2E8F0; /* slate-200 */
            background-image: radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), transparent 30%),
                              radial-gradient(circle at bottom right, rgba(168, 85, 247, 0.15), transparent 40%);
        }
        .glass-card {
            background-color: rgba(30, 41, 59, 0.5); /* slate-800 with 50% opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(56, 189, 248, 0.2); /* sky-400 with 20% opacity */
        }
        .btn-primary {
            background: linear-gradient(to right, #22D3EE, #3B82F6); /* cyan-400 to blue-500 */
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
        }
        .tab-active {
            background: linear-gradient(to right, #22D3EE, #3B82F6); /* cyan-400 to blue-500 */
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }
        .view {
            display: none;
        }
        .view-active {
            display: block;
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1E293B; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; /* slate-700 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; /* slate-600 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Print styles */
        @media print {
            body > *:not(.print-area) {
                display: none !important;
            }
            .print-area, .print-area .modal-content {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                background-color: white !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
            }
            .no-print {
                display: none !important;
            }
            .printable-content {
                color: black !important;
            }
            .printable-content * {
                color: black !important;
                background-color: transparent !important;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Welcome View -->
    <div id="welcome-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-lg p-8 text-center glass-card rounded-2xl shadow-lg fade-in">
            <div class="flex items-center justify-center space-x-4 mb-6">
                <div class="bg-cyan-400 p-3 rounded-full text-slate-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                </div>
                <h1 class="text-3xl font-bold text-white">Selamat Datang di SmartPresensi</h1>
            </div>
            <p class="text-slate-300 mt-4 mb-8">
                Solusi digital untuk manajemen kehadiran siswa yang efisien dan modern. Catat kehadiran, kelola data, dan buat laporan dengan mudah. Semua data disimpan dengan aman di browser Anda.
            </p>
            <button id="start-button" class="w-full max-w-xs mx-auto py-3 px-4 text-white font-semibold rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-400 focus:ring-offset-slate-900 btn-primary">
                Mulai
            </button>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 glass-card rounded-2xl shadow-lg">
            <div class="text-center">
                 <div class="flex items-center justify-center space-x-3 mb-4">
                    <div class="bg-cyan-400 p-2 rounded-full text-slate-900">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <h1 class="text-2xl font-bold text-white">SmartPresensi</h1>
                </div>
                <p class="text-slate-400">Silakan login untuk melanjutkan</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="text-sm font-medium text-slate-300">Username</label>
                    <input id="username" name="username" type="text" required class="w-full px-3 py-2 mt-1 bg-slate-700 border border-slate-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-cyan-400 focus:border-cyan-400" placeholder="contoh: admin">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-slate-300">Password</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 bg-slate-700 border border-slate-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-cyan-400 focus:border-cyan-400" placeholder="contoh: admin123">
                </div>
                 <p id="login-error" class="text-sm text-red-400 text-center hidden">Username atau password salah.</p>
                <div>
                    <button type="submit" class="w-full py-2 px-4 text-white font-semibold rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-400 focus:ring-offset-slate-900 btn-primary">
                        Login
                    </button>
                </div>
            </form>
             <div class="text-xs text-slate-500 text-center">
                <p>MAPPAGURU ONLINE - MUHAMMAD HASRATUL</p>
                <p><b class="text-slate-400">AKUN DEMO :</b> admin / admin123</p>
                <p>CONTACT PERSON : 085259259767 (Chat Only)</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="min-h-screen hidden">
        <!-- Header -->
        <header class="glass-card sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="bg-cyan-400 p-2 rounded-full text-slate-900">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                        </div>
                        <h1 class="text-xl font-bold text-white">SmartPresensi</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="header-date" class="text-sm text-slate-400 font-medium hidden sm:block"></div>
                        <div class="text-right hidden sm:block">
                            <div id="user-name" class="font-semibold text-white"></div>
                            <div id="user-role" class="text-xs text-slate-400 capitalize"></div>
                        </div>
                        <button id="logout-button" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-white" title="Logout">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Navigation Tabs -->
            <div id="main-nav" class="mb-6 flex justify-center">
                <nav class="flex space-x-2 glass-card p-1 rounded-full" aria-label="Tabs">
                    <button id="tab-dashboard" onclick="showView('dashboard')" class="tab py-2 px-4 rounded-full font-medium text-sm transition-colors duration-300">
                        Dashboard
                    </button>
                    <button id="tab-presensi" onclick="showView('presensi')" class="tab py-2 px-4 rounded-full font-medium text-sm transition-colors duration-300">
                        Input Kehadiran
                    </button>
                    <button id="tab-laporan" onclick="showView('laporan')" class="tab py-2 px-4 rounded-full font-medium text-sm transition-colors duration-300">
                        Laporan
                    </button>
                    <button id="tab-pengaturan" onclick="showView('pengaturan')" class="tab py-2 px-4 rounded-full font-medium text-sm transition-colors duration-300">
                        Pengaturan
                    </button>
                </nav>
            </div>

            <!-- Views for Admin/Guru -->
            <div id="admin-guru-content">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view">
                    <!-- Content injected by JS -->
                </div>
                <!-- Presensi View -->
                <div id="view-presensi" class="view">
                    <!-- Content injected by JS -->
                </div>
                <!-- Laporan View -->
                <div id="view-laporan" class="view">
                    <!-- Content injected by JS -->
                </div>
                <!-- Pengaturan View (Admin only) -->
                 <div id="view-pengaturan" class="view">
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-6">
                             <!-- User & Class Management -->
                             <div class="glass-card p-6 rounded-xl shadow-lg">
                                 <h2 class="text-lg font-semibold text-white mb-4">Manajemen Umum</h2>
                                 <div class="space-y-4">
                                     <div class="p-4 border border-slate-700 rounded-lg flex flex-col glass-card">
                                         <h3 class="font-semibold text-white">Manajemen Pengguna</h3>
                                         <p class="text-sm text-slate-400 mt-1 flex-grow">Tambah, edit, atau hapus data admin, guru, dan siswa.</p>
                                         <button onclick="openUserModal()" class="mt-3 text-sm text-white font-semibold py-2 px-4 rounded-md w-full btn-primary">Kelola Pengguna</button>
                                     </div>
                                     <div class="p-4 border border-slate-700 rounded-lg flex flex-col glass-card">
                                         <h3 class="font-semibold text-white">Manajemen Kelas & Siswa</h3>
                                         <p class="text-sm text-slate-400 mt-1 flex-grow">Atur daftar kelas dan alokasi siswa per kelas.</p>
                                         <button onclick="openClassModal()" class="mt-3 text-sm text-white font-semibold py-2 px-4 rounded-md w-full btn-primary">Kelola Kelas</button>
                                     </div>
                                 </div>
                             </div>
                             <!-- Data Management -->
                             <div class="glass-card p-6 rounded-xl shadow-lg border border-slate-700">
                                <h2 class="text-lg font-semibold text-white mb-4">Manajemen Data Aplikasi</h2>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onclick="backupData()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                                        <span>Backup</span>
                                    </button>
                                    <button onclick="document.getElementById('restore-input').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 12.5A2.5 2.5 0 0 1 3 10h10a2.5 2.5 0 0 1 2.5 2.5v2.5a.5.5 0 0 1-1 0v-2.5a1.5 1.5 0 0 0-1.5-1.5H3A1.5 1.5 0 0 0 1.5 12.5v2.5a.5.5 0 0 1-1 0v-2.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                                        <span>Restore</span>
                                    </button>
                                    <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                                    <button onclick="resetAllData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center space-x-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                        <span>Reset Data</span>
                                    </button>
                                </div>
                                <p class="text-xs text-slate-400 mt-4">Reset Data akan mengembalikan aplikasi ke kondisi awal (hanya akun admin default yang tersisa).</p>
                            </div>
                        </div>
                        <!-- Right Column -->
                        <div class="glass-card p-6 rounded-xl shadow-lg">
                             <h2 class="text-lg font-semibold text-white mb-4">Pengaturan Laporan PDF</h2>
                             <form id="report-settings-form" class="space-y-4">
                                 <div>
                                     <label for="setting-school-name" class="block text-sm font-medium text-slate-300">Nama Sekolah</label>
                                     <input type="text" id="setting-school-name" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white focus:ring-cyan-400 focus:border-cyan-400">
                                 </div>
                                 <div>
                                     <label for="setting-teacher-name" class="block text-sm font-medium text-slate-300">Nama Guru / Wali Kelas</label>
                                     <input type="text" id="setting-teacher-name" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white focus:ring-cyan-400 focus:border-cyan-400">
                                 </div>
                                 <div>
                                     <label for="setting-nip" class="block text-sm font-medium text-slate-300">NIP</label>
                                     <input type="text" id="setting-nip" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white focus:ring-cyan-400 focus:border-cyan-400">
                                 </div>
                                 <div>
                                     <label for="setting-endorsement-place" class="block text-sm font-medium text-slate-300">Tempat & Tanggal Pengesahan</label>
                                     <input type="text" id="setting-endorsement-place" placeholder="Contoh: Makassar, 01 Januari 2024" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white focus:ring-cyan-400 focus:border-cyan-400">
                                 </div>
                                 <button type="submit" class="w-full text-white font-semibold py-2 px-4 rounded-md btn-primary">Simpan Pengaturan</button>
                             </form>
                         </div>
                     </div>
                </div>
            </div>

            <!-- View for Siswa -->
            <div id="siswa-content" class="hidden">
                 <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-2">Rekap Kehadiran Anda</h2>
                    <p class="text-sm text-slate-400 mb-6">Berikut adalah catatan kehadiran Anda selama ini.</p>
                    
                    <div id="student-summary" class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6">
                        <!-- Summary cards will be injected here -->
                    </div>

                    <div class="overflow-x-auto border border-slate-700 rounded-lg">
                       <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-800/50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Diubah Oleh</th>
                                </tr>
                            </thead>
                            <tbody id="student-attendance-table" class="divide-y divide-slate-700">
                                <!-- Student's personal attendance rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer id="app-footer" class="text-center py-4 border-t border-slate-800 glass-card hidden">
        <p class="text-sm text-slate-400 font-semibold">SMARTPRESENSI - MUHAMMAD HASRATUL</p>
    </footer>

    <!-- Modals -->
    <div id="audit-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4"></div>
    <div id="user-management-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4"></div>
    <div id="class-management-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4"></div>
    <div id="student-card-modal" class="modal fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4"></div>
    
    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 border border-cyan-400">
        <p id="toast-message"></p>
    </div>

    <script>
        // --- DATA VARIABLES & LOCAL STORAGE ---
        let users = {};
        let students = {};
        let attendanceData = {};
        let auditLog = {};
        let reportSettings = {};
        let currentUser = null;

        const APP_DATA_KEY = 'smartPresensiData';

        function saveDataToStorage() {
            const appData = {
                users,
                students,
                attendanceData,
                auditLog,
                reportSettings
            };
            localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
        }

        function loadDataFromStorage() {
            const savedData = localStorage.getItem(APP_DATA_KEY);
            if (savedData) {
                const appData = JSON.parse(savedData);
                users = appData.users || {};
                students = appData.students || {};
                attendanceData = appData.attendanceData || {};
                auditLog = appData.auditLog || {};
                reportSettings = appData.reportSettings || { schoolName: '', teacherName: '', nip: '', endorsementPlace: '' };
                if (Object.keys(users).length === 0) {
                     initializeMockData();
                }
            } else {
                initializeMockData();
            }
        }
        
        function initializeMockData() {
            users = {
                'admin': { pass: 'admin123', role: 'admin', name: 'Admin Utama', gender: 'L' }
            };
            students = {};
            attendanceData = {};
            auditLog = {};
            reportSettings = { schoolName: 'Nama Sekolah Anda', teacherName: 'Nama Guru', nip: '1234567890', endorsementPlace: 'Kota, 01 Januari 2024' };
            saveDataToStorage();
        }

        // --- STATE & ELEMENTS ---
        let selectedKelas = '10A';
        let selectedTanggal = new Date().toISOString().slice(0, 10);
        let currentStudentCardNis = null;
        const statusConfig = {
            Hadir: { text: "Hadir", color: "bg-green-500/20 text-green-300", ring: "ring-green-400", chartColor: '#4ADE80' },
            Sakit: { text: "Sakit", color: "bg-yellow-500/20 text-yellow-300", ring: "ring-yellow-400", chartColor: '#FACC15' },
            Izin: { text: "Izin", color: "bg-sky-500/20 text-sky-300", ring: "ring-sky-400", chartColor: '#38BDF8' },
            Alpa: { text: "Alpa", color: "bg-red-500/20 text-red-300", ring: "ring-red-400", chartColor: '#F87171' },
            Terlambat: { text: "Terlambat", color: "bg-purple-500/20 text-purple-300", ring: "ring-purple-400", chartColor: '#C084FC' },
        };
        
        // --- AUTH & UI SETUP ---
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const user = users[username];

            if (user && user.pass === pass) {
                currentUser = { ...user, username };
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app-footer').classList.remove('hidden');
                document.getElementById('app').classList.add('fade-in');
                document.getElementById('login-error').classList.add('hidden');
                setupUIForRole();
            } else {
                 document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('app').classList.add('hidden');
            document.getElementById('app-footer').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('login-view').classList.add('fade-in');
            document.getElementById('password').value = '';
        }

        function setupUIForRole() {
            if (!currentUser) return;
            
            displayCurrentDate();
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role;

            const adminGuruContent = document.getElementById('admin-guru-content');
            const siswaContent = document.getElementById('siswa-content');
            const mainNav = document.getElementById('main-nav');
            
            adminGuruContent.style.display = 'none';
            siswaContent.style.display = 'none';
            mainNav.style.display = 'none';

            if (currentUser.role === 'admin' || currentUser.role === 'guru') {
                adminGuruContent.style.display = 'block';
                mainNav.style.display = 'flex';
                document.getElementById('tab-dashboard').style.display = 'block';
                document.getElementById('tab-presensi').style.display = 'block';
                document.getElementById('tab-laporan').style.display = 'block';
                document.getElementById('tab-pengaturan').style.display = currentUser.role === 'admin' ? 'block' : 'none';
                showView('dashboard');
            } else if (currentUser.role === 'siswa') {
                const studentData = Object.values(students).flat().find(s => s.nis === currentUser.username);
                 if (studentData) {
                    currentUser.name = studentData.name;
                    currentUser.nis = studentData.nis;
                    document.getElementById('user-name').textContent = studentData.name;
                }
                siswaContent.style.display = 'block';
                renderStudentDashboard();
            }
        }
        
        // --- DASHBOARD ---
        function renderDashboard() {
            const dashboardView = document.getElementById('view-dashboard');

            // Agregasi data untuk dasbor
            const studentStats = {};
            const classStats = {};

            // Inisialisasi statistik kelas
            Object.keys(students).forEach(className => {
                classStats[className] = { name: className, alpaCount: 0 };
            });

            // Inisialisasi statistik siswa
            Object.values(students).flat().forEach(student => {
                studentStats[student.nis] = {
                    nis: student.nis,
                    name: student.name,
                    kelas: Object.keys(students).find(k => students[k].some(s => s.nis === student.nis)),
                    Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0, Terlambat: 0
                };
            });

            // Hitung statistik dari data kehadiran
            Object.values(attendanceData).forEach(dayData => {
                Object.entries(dayData).forEach(([nis, record]) => {
                    if (studentStats[nis] && record.status) {
                        if(studentStats[nis][record.status] !== undefined) {
                            studentStats[nis][record.status]++;
                        }
                        if (record.status === 'Alpa' && studentStats[nis].kelas && classStats[studentStats[nis].kelas]) {
                            classStats[studentStats[nis].kelas].alpaCount++;
                        }
                    }
                });
            });

            const allStudentsArray = Object.values(studentStats);

            const topClassesAlpa = Object.values(classStats)
                .filter(c => c.alpaCount > 0)
                .sort((a, b) => b.alpaCount - a.alpaCount)
                .slice(0, 5); // Mengambil 5 teratas sesuai permintaan


            const createTopListHTML = (title, data, key, statusKey) => {
                const topStudents = data.filter(s => s[key] > 0).sort((a, b) => b[key] - a[key]).slice(0, 10);
                const statusColor = statusConfig[statusKey]?.color || 'bg-slate-500/20 text-slate-300';
                
                if (topStudents.length === 0) {
                    return `
                    <div class="glass-card p-4 rounded-xl">
                        <h3 class="font-semibold text-white mb-3">${title}</h3>
                        <p class="text-sm text-slate-400 text-center py-8">Tidak ada data.</p>
                    </div>`;
                }

                return `
                <div class="glass-card p-4 rounded-xl flex flex-col">
                    <h3 class="font-semibold text-white mb-3">${title}</h3>
                    <div class="overflow-y-auto max-h-80 pr-2">
                        <ol class="space-y-2">
                            ${topStudents.map((s, i) => `
                            <li class="text-sm flex items-center justify-between p-2 rounded-md hover:bg-slate-700/50">
                                <div class="flex items-center">
                                    <span class="text-xs font-bold text-slate-500 w-6">${i + 1}.</span>
                                    <div>
                                        <p class="text-slate-200 font-medium">${s.name}</p>
                                        <p class="text-xs text-slate-400">${s.kelas}</p>
                                    </div>
                                </div>
                                <span class="text-sm font-bold px-2 py-1 rounded-full ${statusColor}">${s[key]}</span>
                            </li>`).join('')}
                        </ol>
                    </div>
                </div>`;
            };

            dashboardView.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        ${createTopListHTML('Top 10 Siswa Alpa', allStudentsArray, 'Alpa', 'Alpa')}
                        ${createTopListHTML('Top 10 Siswa Izin', allStudentsArray, 'Izin', 'Izin')}
                    </div>
                    <div class="space-y-6">
                        ${createTopListHTML('Top 10 Siswa Sakit', allStudentsArray, 'Sakit', 'Sakit')}
                        
                        <div class="glass-card p-4 rounded-xl flex flex-col">
                            <h3 class="font-semibold text-white mb-3">Top 5 Kelas Rawan Alpa</h3>
                            <div class="overflow-y-auto max-h-80 pr-2">
                                ${topClassesAlpa.length > 0 ? `
                                <ul class="space-y-2">
                                    ${topClassesAlpa.map(c => `
                                    <li class="text-sm flex justify-between items-center p-2 rounded-md hover:bg-slate-700/50">
                                        <span class="font-medium text-slate-200">${c.name}</span>
                                        <span class="font-bold text-red-400">${c.alpaCount} Alpa</span>
                                    </li>`).join('')}
                                </ul>` : `<p class="text-sm text-slate-400 text-center py-8">Tidak ada kelas dengan catatan alpa.</p>`}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- STUDENT DASHBOARD ---
        function renderStudentDashboard() {
            const studentNis = currentUser.username;
            const summaryContainer = document.getElementById('student-summary');
            const tableBody = document.getElementById('student-attendance-table');
            
            let studentRecords = [];
            let summary = { Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0, Terlambat: 0 };

            Object.keys(attendanceData).forEach(date => {
                if (attendanceData[date] && attendanceData[date][studentNis]) {
                    const record = attendanceData[date][studentNis];
                    studentRecords.push({ date, ...record });
                    if(summary[record.status] !== undefined) summary[record.status]++;
                }
            });
            
            summaryContainer.innerHTML = Object.keys(summary).map(status => `
                <div class="p-4 rounded-lg ${statusConfig[status].color} border border-white/10">
                    <div class="text-2xl font-bold text-white">${summary[status]}</div>
                    <div class="text-sm font-semibold">${status}</div>
                </div>
            `).join('');

            tableBody.innerHTML = studentRecords.length > 0 ? studentRecords.sort((a,b) => new Date(b.date) - new Date(a.date)).map(rec => `
                <tr class="hover:bg-slate-700/50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${new Date(rec.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric'})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusConfig[rec.status].color}">${rec.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${rec.editor}</td>
                </tr>
            `).join('') : `<tr><td colspan="3" class="text-center py-10 text-slate-400">Belum ada data kehadiran.</td></tr>`;
        }


        // --- HTML INJECTION & MODALS ---
        function injectHTMLContent() {
            document.getElementById('view-presensi').innerHTML = `
                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Pencatatan Kehadiran Siswa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="kelas-filter" class="block text-sm font-medium text-slate-300 mb-1">Kelas</label>
                            <select id="kelas-filter" class="w-full rounded-md bg-slate-700 border-slate-600 text-white shadow-sm focus:border-cyan-400 focus:ring-cyan-400"></select>
                        </div>
                        <div>
                            <label for="tanggal-filter" class="block text-sm font-medium text-slate-300 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-filter" class="w-full rounded-md bg-slate-700 border-slate-600 text-white shadow-sm focus:border-cyan-400 focus:ring-cyan-400" style="color-scheme: dark;">
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh]"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-800/50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Nama Siswa</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">NIS</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status Kehadiran</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Catatan</th></tr></thead><tbody id="student-table-body" class="divide-y divide-slate-700"></tbody></table></div>
                </div>`;
            
            document.getElementById('view-laporan').innerHTML = `
                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-white mb-4">Laporan Kehadiran</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                         <div><label for="laporan-kelas-filter" class="block text-sm font-medium text-slate-300 mb-1">Kelas</label><select id="laporan-kelas-filter" class="w-full rounded-md bg-slate-700 border-slate-600 text-white shadow-sm focus:border-cyan-400 focus:ring-cyan-400"></select></div>
                         <div><label for="laporan-start-date" class="block text-sm font-medium text-slate-300 mb-1">Tgl Mulai</label><input type="date" id="laporan-start-date" class="w-full rounded-md bg-slate-700 border-slate-600 text-white shadow-sm focus:border-cyan-400 focus:ring-cyan-400" style="color-scheme: dark;"></div>
                        <div><label for="laporan-end-date" class="block text-sm font-medium text-slate-300 mb-1">Tgl Akhir</label><input type="date" id="laporan-end-date" class="w-full rounded-md bg-slate-700 border-slate-600 text-white shadow-sm focus:border-cyan-400 focus:ring-cyan-400" style="color-scheme: dark;"></div>
                        <button id="generate-report-btn" class="w-full md:w-auto text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors duration-200 flex items-center justify-center space-x-2 btn-primary"><span>Buat Laporan</span></button>
                    </div>
                    <div id="report-result" class="hidden">
                        <div class="flex justify-between items-center mb-4"><h3 id="report-title" class="text-md font-semibold text-white"></h3><div class="flex space-x-2"><button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md shadow-sm text-sm">Excel</button><button id="export-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md shadow-sm text-sm">PDF</button></div></div>
                        <div class="overflow-x-auto max-h-[60vh] border border-slate-700 rounded-lg"><table id="report-table" class="min-w-full divide-y divide-slate-700"><thead id="report-table-head" class="bg-slate-800/50"></thead><tbody id="report-table-body" class="divide-y divide-slate-700"></tbody></table></div>
                        <div id="top-students-report" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>`;

            document.getElementById('audit-modal').innerHTML = `<div class="glass-card rounded-lg shadow-xl w-full max-w-lg"><div class="p-5 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-semibold text-white">Riwayat Perubahan</h3><button onclick="closeModal('audit-modal')" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button></div><div class="p-5 max-h-96 overflow-y-auto"><p class="text-sm mb-4 text-slate-300">Mencatat perubahan status untuk <strong id="modal-student-name" class="text-white"></strong> pada tanggal <strong id="modal-date" class="text-white"></strong>.</p><div id="audit-log-content"></div></div><div class="p-4 bg-slate-800/50 flex justify-end"><button onclick="closeModal('audit-modal')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-md">Tutup</button></div></div>`;
            document.getElementById('student-card-modal').innerHTML = `<div class="glass-card rounded-lg shadow-xl w-full max-w-2xl modal-content"><div class="p-5 border-b border-slate-700 flex justify-between items-center no-print"><h3 class="text-lg font-semibold text-white">Kartu Informasi Kehadiran</h3><button onclick="closeModal('student-card-modal')" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button></div><div id="student-card-content" class="p-5 printable-content"></div><div class="p-4 bg-slate-800/50 flex justify-end space-x-2 no-print"><button onclick="printStudentCard()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-md">Print</button><button onclick="downloadStudentCardPDF()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Unduh PDF</button><button onclick="closeModal('student-card-modal')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-md">Tutup</button></div></div>`;

            document.getElementById('user-management-modal').innerHTML = `
                 <div class="glass-card rounded-lg shadow-xl w-full max-w-3xl"><div class="p-5 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-semibold text-white">Manajemen Pengguna</h3><button onclick="closeModal('user-management-modal')" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button></div><div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2"><h4 class="font-medium text-white mb-2">Daftar Pengguna</h4><div class="overflow-y-auto max-h-96 border border-slate-700 rounded-lg"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-800/50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Username</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Gender</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Peran</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400 uppercase">Aksi</th></tr></thead><tbody id="user-list-body" class="divide-y divide-slate-700"></tbody></table></div></div><div><h4 class="font-medium mb-2 text-white" id="user-form-title">Tambah Pengguna Baru</h4><form id="user-form" class="space-y-3"><input type="hidden" id="edit-username"><input type="hidden" id="original-username"><div><label class="text-sm text-slate-300">Username</label><input id="user-username" type="text" required class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"></div><div><label class="text-sm text-slate-300">Nama Lengkap</label><input id="user-fullname" type="text" required class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"></div><div><label class="text-sm text-slate-300">Password</label><input id="user-password" type="password" required class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"></div><div><label class="text-sm text-slate-300">Jenis Kelamin</label><select id="user-gender" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div><div><label class="text-sm text-slate-300">Peran</label><select id="user-role-select" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"><option value="admin">Admin</option><option value="guru">Guru</option><option value="siswa">Siswa</option></select></div><div id="siswa-fields" class="hidden"><p class="text-xs text-slate-400 pt-2 border-t border-slate-700">Jika peran adalah siswa, NIS akan digunakan sebagai username. Siswa ditambahkan melalui Manajemen Kelas.</p></div><div class="flex space-x-2 mt-4"><button type="submit" class="w-full text-white py-2 rounded btn-primary">Simpan</button><button type="button" id="clear-user-form-btn" class="w-full bg-slate-600 text-white py-2 rounded">Batal</button></div></form></div></div></div>`;
            document.getElementById('class-management-modal').innerHTML = `
                 <div class="glass-card rounded-lg shadow-xl w-full max-w-4xl"><div class="p-5 border-b border-slate-700 flex justify-between items-center"><h3 class="text-lg font-semibold text-white">Manajemen Kelas & Siswa</h3><button onclick="closeModal('class-management-modal')" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button></div><div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-6 max-h-[80vh] overflow-y-auto"><div class="md:col-span-1"><h4 class="font-medium text-white mb-2">Daftar Kelas</h4><div id="class-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div><h4 class="font-medium text-white mb-2 mt-4">Tambah Kelas Baru</h4><form id="class-form" class="flex space-x-2"><input id="class-name-input" type="text" placeholder="Nama Kelas" required class="w-full p-2 rounded bg-slate-700 border-slate-600 text-white"><button type="submit" class="p-2 rounded btn-primary text-white">+</button></form></div><div class="md:col-span-2"><div class="flex justify-between items-center mb-2 flex-wrap gap-2"><h4 class="font-medium text-white">Siswa di Kelas <span id="selected-class-name" class="font-bold text-cyan-400"></span></h4><div class="flex space-x-2"><button id="import-excel-btn" class="text-sm bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-3 rounded-md">Import Excel</button><button id="add-student-btn" class="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-md">Tambah Siswa</button><input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls"></div></div><p class="text-xs text-slate-400 mb-2">Import Excel harus memiliki kolom: <strong>NIS, Nama, Gender (L/P)</strong>.</p><div id="student-in-class-list" class="overflow-y-auto max-h-96 border border-slate-700 rounded-lg"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-800/50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-400">NIS</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400">Gender</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-400">Aksi</th></tr></thead><tbody id="student-in-class-tbody" class="divide-y divide-slate-700"></tbody></table></div><div id="add-student-form-container" class="mt-4 p-4 border border-slate-700 rounded-lg hidden"><h5 class="font-medium text-white mb-2">Form Siswa</h5><form id="add-student-form" class="space-y-2"><input type="hidden" id="edit-student-nis"><div><label class="text-sm text-slate-300">NIS</label><input id="student-nis-input" required class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"></div><div><label class="text-sm text-slate-300">Nama Lengkap</label><input id="student-name-input" required class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"></div><div><label class="text-sm text-slate-300">Jenis Kelamin</label><select id="student-gender-input" class="w-full text-sm p-2 mt-1 rounded bg-slate-700 border-slate-600 text-white"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div><div class="flex space-x-2"><button type="submit" class="text-white px-4 py-2 rounded btn-primary">Simpan</button><button type="button" id="cancel-add-student-btn" class="bg-slate-600 px-4 py-2 rounded text-white">Batal</button></div></form></div></div></div></div>`;
        }
        
        function setupEventListeners() {
            // Static elements
            document.getElementById('start-button').addEventListener('click', () => {
                document.getElementById('welcome-view').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('login-view').classList.add('flex', 'fade-in');
            });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);

            // Dynamically injected elements
            document.getElementById('kelas-filter').addEventListener('change', (e) => { selectedKelas = e.target.value; renderStudentTable(); });
            document.getElementById('tanggal-filter').addEventListener('change', (e) => { selectedTanggal = e.target.value; renderStudentTable(); });
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('report-settings-form').addEventListener('submit', saveReportSettings);
            document.getElementById('user-form').addEventListener('submit', handleUserForm);
            document.getElementById('clear-user-form-btn').addEventListener('click', clearUserForm);
            document.getElementById('user-role-select').addEventListener('change', toggleSiswaFields);
            document.getElementById('class-form').addEventListener('submit', handleClassForm);
            document.getElementById('add-student-btn').addEventListener('click', () => toggleStudentForm(true));
            document.getElementById('cancel-add-student-btn').addEventListener('click', () => toggleStudentForm(false));
            document.getElementById('add-student-form').addEventListener('submit', handleStudentForm);
            document.getElementById('import-excel-btn').addEventListener('click', handleExcelImport);
            document.getElementById('excel-file-input').addEventListener('change', processExcelFile);
        }

        function displayCurrentDate() {
            const dateElement = document.getElementById('header-date');
            if (dateElement) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('id-ID', options);
            }
        }

        function renderStudentTable() {
            const studentTableBody = document.getElementById('student-table-body');
            studentTableBody.innerHTML = '';
            const currentStudents = students[selectedKelas] || [];

            if (currentStudents.length === 0) {
                studentTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400">Tidak ada data siswa di kelas ini.</td></tr>`;
                return;
            }

            if (!attendanceData[selectedTanggal]) {
                attendanceData[selectedTanggal] = {};
            }
            const dayData = attendanceData[selectedTanggal];

            currentStudents.forEach(student => {
                if (!dayData[student.nis]) {
                    dayData[student.nis] = { status: 'Hadir', editor: 'Sistem', timestamp: new Date().toISOString(), note: '' };
                    
                    if (!auditLog[selectedTanggal]) auditLog[selectedTanggal] = {};
                    if (!auditLog[selectedTanggal][student.nis]) auditLog[selectedTanggal][student.nis] = [];
                    auditLog[selectedTanggal][student.nis].push({ 
                        from: 'Belum Tercatat', 
                        to: 'Hadir', 
                        user: 'Sistem', 
                        timestamp: new Date().toISOString() 
                    });
                }
            });
            saveDataToStorage();

            currentStudents.forEach((student, index) => {
                const studentStatus = dayData[student.nis].status;
                const note = dayData[student.nis].note || '';
                const statusButtons = Object.keys(statusConfig).map(status => {
                    const isActive = studentStatus === status;
                    const config = statusConfig[status];
                    return `<button data-nis="${student.nis}" data-status="${status}" class="status-btn text-xs font-semibold py-1 px-3 rounded-full transition-all duration-200 ${isActive ? `${config.color} ring-2 ${config.ring}` : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">${config.text}</button>`;
                }).join('');

                const row = `<tr class="hover:bg-slate-700/50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${student.nis}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400"><div class="flex items-center space-x-2">${statusButtons}<button title="Lihat Riwayat" class="text-slate-500 hover:text-cyan-400" onclick="showAuditModal('${student.nis}', '${student.name}')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg></button></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="text" data-nis="${student.nis}" class="note-input w-full bg-slate-800 border-slate-600 rounded px-2 py-1 text-sm text-slate-200 focus:ring-cyan-400 focus:border-cyan-400" onchange="handleNoteChange(this)" value="${note}" placeholder="Catatan..."></td>
                    </tr>`;
                studentTableBody.insertAdjacentHTML('beforeend', row);
            });
            document.querySelectorAll('.status-btn').forEach(btn => btn.addEventListener('click', handleStatusChange));
        }
        
        function handleNoteChange(inputElement) {
            const nis = inputElement.dataset.nis;
            const note = inputElement.value.trim();

            if (attendanceData[selectedTanggal] && attendanceData[selectedTanggal][nis]) {
                attendanceData[selectedTanggal][nis].note = note;
                saveDataToStorage();
                showToast(`Catatan untuk siswa NIS ${nis} diperbarui.`);
            }
        }
        
        function handleStatusChange(event) {
            const { nis, status } = event.target.dataset;
            const timestamp = new Date();
            if (!attendanceData[selectedTanggal]) attendanceData[selectedTanggal] = {};
            if (!auditLog[selectedTanggal]) auditLog[selectedTanggal] = {};
            if (!auditLog[selectedTanggal][nis]) auditLog[selectedTanggal][nis] = [];

            const currentRecord = attendanceData[selectedTanggal][nis];
            const oldStatus = currentRecord ? currentRecord.status : 'Hadir';
            const existingNote = currentRecord ? currentRecord.note : '';

            if (oldStatus !== status) {
                attendanceData[selectedTanggal][nis] = { status, editor: currentUser.name, timestamp: timestamp.toISOString(), note: existingNote };
                auditLog[selectedTanggal][nis].push({ from: oldStatus, to: status, user: currentUser.name, timestamp: timestamp.toISOString() });
                const studentName = (students[selectedKelas]?.find(s=>s.nis === nis) || {}).name || 'Siswa';
                showToast(`Status ${studentName} diubah menjadi ${status}.`);
                if (status === 'Alpa' || status === 'Terlambat') {
                    setTimeout(() => showToast(`Notifikasi ${status} dikirim ke wali murid.`, 'info'), 1000);
                }
            }
            saveDataToStorage();
            renderStudentTable();
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            
            let styles = 'bg-green-500/50 border-green-400'; // success
            if (type === 'info') styles = 'bg-sky-500/50 border-sky-400';
            if (type === 'error') styles = 'bg-red-500/50 border-red-400';

            toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transform transition-all duration-300 border ${styles}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
            document.getElementById(`view-${viewName}`).classList.add('view-active', 'fade-in');
            
            document.querySelectorAll('nav button.tab').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('text-slate-400', 'hover:text-white');
            });

            const activeTab = document.getElementById(`tab-${viewName}`);
            if(activeTab) {
                activeTab.classList.add('tab-active');
                activeTab.classList.remove('text-slate-400', 'hover:text-white');
            }

            if (viewName === 'dashboard') {
                renderDashboard();
            } else if (viewName === 'presensi') {
                renderStudentTable();
            } else if (viewName === 'pengaturan') {
                loadReportSettings();
            }
        }
        
        function showAuditModal(nis, name) {
            const modal = document.getElementById('audit-modal');
            document.getElementById('modal-student-name').textContent = name;
            document.getElementById('modal-date').textContent = new Date(selectedTanggal).toLocaleDateString('id-ID', { dateStyle: 'full' });
            const logContent = document.getElementById('audit-log-content');
            logContent.innerHTML = '';
            const logs = auditLog[selectedTanggal]?.[nis] || [];
            
            if (logs.length === 0) {
                 logContent.innerHTML = '<p class="text-sm text-slate-400">Belum ada riwayat.</p>';
            } else {
                logContent.innerHTML = logs.slice().reverse().map(log => {
                    const fromStyle = statusConfig[log.from] ? statusConfig[log.from].color : 'bg-slate-500/20 text-slate-300';
                    const toStyle = statusConfig[log.to] ? statusConfig[log.to].color : 'bg-slate-500/20 text-slate-300';
                    return `<div class="relative pl-6 pb-6 border-l-2 border-slate-700"><div class="absolute -left-2 top-0 w-4 h-4 bg-cyan-400 rounded-full border-2 border-slate-800"></div><p class="text-sm text-slate-400">${new Date(log.timestamp).toLocaleTimeString('id-ID')} - oleh ${log.user}</p><p class="text-sm font-medium text-slate-200">Status diubah dari <span class="font-bold px-2 py-0.5 rounded ${fromStyle}">${log.from}</span> ke <span class="font-bold px-2 py-0.5 rounded ${toStyle}">${log.to}</span>.</p></div>`
                }).join('');
            }
            modal.classList.add('flex');
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }
        
        let currentReportData = [];
        function generateReport() {
            const kelas = document.getElementById('laporan-kelas-filter').value;
            const startDate = new Date(document.getElementById('laporan-start-date').value);
            const endDate = new Date(document.getElementById('laporan-end-date').value);
            if (isNaN(startDate) || isNaN(endDate)) { alert('Tanggal tidak valid.'); return; }
            let reportData = []; let allDates = [];
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { allDates.push(new Date(d).toISOString().slice(0, 10)); }
            const classesToReport = kelas === 'all' ? Object.keys(students) : [kelas];
            classesToReport.forEach(k => {
                if (students[k]) {
                    students[k].forEach(student => {
                        let row = { kelas: k, nis: student.nis, nama: student.name };
                        let summary = { Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0, Terlambat: 0 };
                        allDates.forEach(date => { 
                            const dayData = attendanceData[date];
                            const record = dayData && dayData[student.nis];
                            const status = record ? record.status : 'Hadir'; // Default to Hadir in report
                            row[date] = status;
                            row[`${date}_note`] = record ? record.note : '';
                            if(summary[status] !== undefined) summary[status]++; 
                        });
                        row.summary = summary;
                        reportData.push(row);
                    });
                }
            });
            currentReportData = reportData; 
            displayReport(reportData, allDates);
            displayTopStudentsReport(reportData);
        }
        function displayReport(data, dates) {
            const head = document.getElementById('report-table-head'); 
            const body = document.getElementById('report-table-body');
            const isSingleDayReport = dates.length === 1;

            let headerHtml = '<tr><th class="px-3 py-3 text-left text-xs font-medium text-slate-400 uppercase">Nama Siswa</th><th class="px-3 py-3 text-left text-xs font-medium text-slate-400 uppercase">Kelas</th>';
            
            if (isSingleDayReport) {
                 headerHtml += `<th class="px-3 py-3 text-center text-xs font-medium text-slate-400 uppercase">Status</th>`;
                 headerHtml += `<th class="px-3 py-3 text-left text-xs font-medium text-slate-400 uppercase">Catatan</th>`;
            } else {
                dates.forEach(d => { headerHtml += `<th class="px-3 py-3 text-center text-xs font-medium text-slate-400 uppercase">${new Date(d).getDate()}</th>`; });
            }
            
            headerHtml += '<th class="px-3 py-3 text-center text-xs font-medium text-green-400 uppercase">H</th><th class="px-3 py-3 text-center text-xs font-medium text-yellow-400 uppercase">S</th><th class="px-3 py-3 text-center text-xs font-medium text-sky-400 uppercase">I</th><th class="px-3 py-3 text-center text-xs font-medium text-red-400 uppercase">A</th><th class="px-3 py-3 text-center text-xs font-medium text-purple-400 uppercase">T</th></tr>';
            head.innerHTML = headerHtml;
            
            let bodyHtml = '';
            data.forEach(row => {
                bodyHtml += `<tr class="hover:bg-slate-700/50"><td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-white flex items-center space-x-2">
                    <span>${row.nama}</span>
                    <button title="Lihat Kartu Kehadiran" class="text-slate-500 hover:text-cyan-400" onclick="showStudentCardModal('${row.nis}')">
                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13zm13 1a.5.5 0 0 1 .5.5v2.5H1v-2.5a.5.5 0 0 1 .5-.5h13zM1 12.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v.5a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-.5z"/></svg>
                    </button>
                </td><td class="px-3 py-2 whitespace-nowrap text-sm text-slate-400">${row.kelas}</td>`;
                
                if (isSingleDayReport) {
                    const status = row[dates[0]];
                    const note = row[`${dates[0]}_note`] || '';
                    const config = statusConfig[status];
                    bodyHtml += `<td class="px-3 py-2 text-center text-sm"><span class="font-mono text-xs font-bold px-1.5 py-0.5 rounded ${config.color}">${status}</span></td>`;
                    bodyHtml += `<td class="px-3 py-2 text-sm text-slate-400">${note}</td>`;
                } else {
                    dates.forEach(d => { const status = row[d]; const config = statusConfig[status]; bodyHtml += `<td class="px-3 py-2 text-center text-sm"><span class="font-mono text-xs font-bold px-1.5 py-0.5 rounded ${config.color}">${status.charAt(0)}</span></td>`; });
                }

                bodyHtml += `<td class="px-3 py-2 text-center text-sm font-semibold text-green-400">${row.summary.Hadir}</td><td class="px-3 py-2 text-center text-sm font-semibold text-yellow-400">${row.summary.Sakit}</td><td class="px-3 py-2 text-center text-sm font-semibold text-sky-400">${row.summary.Izin}</td><td class="px-3 py-2 text-center text-sm font-semibold text-red-400">${row.summary.Alpa}</td><td class="px-3 py-2 text-center text-sm font-semibold text-purple-400">${row.summary.Terlambat}</td></tr>`;
            });
            body.innerHTML = bodyHtml;
            document.getElementById('report-title').textContent = `Laporan Kehadiran Kelas ${document.getElementById('laporan-kelas-filter').value}`;
            document.getElementById('report-result').classList.remove('hidden');
        }

        function showStudentCardModal(nis) {
            currentStudentCardNis = nis;
            const studentData = currentReportData.find(s => s.nis === nis);
            if (!studentData) return;

            const modal = document.getElementById('student-card-modal');
            const content = document.getElementById('student-card-content');
            
            const attendanceDetails = Object.keys(studentData)
                .filter(key => key.match(/^\d{4}-\d{2}-\d{2}$/))
                .map(date => {
                    const status = studentData[date];
                    const config = statusConfig[status];
                    return `<div class="flex justify-between items-center p-2 rounded-md hover:bg-slate-700/50">
                                <span class="text-sm text-slate-300">${new Date(date).toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}</span>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${config.color}">${status}</span>
                            </div>`;
                }).join('');

            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-1 p-4 bg-slate-800/50 rounded-lg">
                        <h4 class="font-bold text-white">${studentData.nama}</h4>
                        <p class="text-sm text-slate-400">NIS: ${studentData.nis}</p>
                        <p class="text-sm text-slate-400">Kelas: ${studentData.kelas}</p>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-5 gap-2 text-center">
                        ${Object.entries(studentData.summary).map(([status, count]) => `
                            <div class="p-2 rounded-lg ${statusConfig[status].color}">
                                <div class="text-xl font-bold text-white">${count}</div>
                                <div class="text-xs font-semibold">${status}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-white mb-2">Rincian Kehadiran</h4>
                    <div class="max-h-60 overflow-y-auto space-y-1 pr-2 border-t border-slate-700 pt-2">
                        ${attendanceDetails || '<p class="text-sm text-slate-400">Tidak ada data untuk ditampilkan.</p>'}
                    </div>
                </div>`;
            modal.classList.add('flex');
        }
        
        function printStudentCard() {
            const modal = document.getElementById('student-card-modal');
            modal.classList.add('print-area');
            window.print();
            modal.classList.remove('print-area');
        }
        
        function downloadStudentCardPDF() {
            const studentData = currentReportData.find(s => s.nis === currentStudentCardNis);
            if (!studentData) {
                showToast("Data siswa tidak ditemukan.", "error");
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    showToast("Pustaka PDF tidak termuat. Coba segarkan halaman.", "error");
                    return;
                }
                const doc = new jsPDF(); // Portrait is default

                // Header
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(reportSettings.schoolName || 'SmartPresensi', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Kartu Rincian Kehadiran Siswa', 105, 28, { align: 'center' });
                doc.setLineWidth(0.5);
                doc.line(20, 32, 190, 32);

                // Student Info
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('Nama Siswa', 14, 45);
                doc.text('NIS', 14, 52);
                doc.text('Kelas', 14, 59);
                doc.text('Periode Laporan', 14, 66);
                
                doc.setFont('helvetica', 'normal');
                doc.text(`: ${studentData.nama}`, 50, 45);
                doc.text(`: ${studentData.nis}`, 50, 52);
                doc.text(`: ${studentData.kelas}`, 50, 59);
                const startDateValue = new Date(document.getElementById('laporan-start-date').value).toLocaleDateString('id-ID');
                const endDateValue = new Date(document.getElementById('laporan-end-date').value).toLocaleDateString('id-ID');
                doc.text(`: ${startDateValue} s/d ${endDateValue}`, 50, 66);
                
                // Details Table
                const head = [['Tanggal', 'Status Kehadiran', 'Catatan']];
                const body = Object.keys(studentData)
                    .filter(key => key.match(/^\d{4}-\d{2}-\d{2}$/))
                    .sort((a, b) => new Date(a) - new Date(b))
                    .map(date => [
                        new Date(date).toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'}),
                        studentData[date],
                        studentData[`${date}_note`] || '-'
                    ]);

                if (body.length > 0) {
                    doc.autoTable({
                        startY: 80,
                        head: head,
                        body: body,
                        theme: 'grid',
                        headStyles: { fillColor: [30, 41, 59] }, // slate-800
                        didParseCell: function(data) {
                            const status = data.cell.raw;
                            if (data.column.dataKey === 1 && statusConfig[status]) {
                                const colorMap = {
                                    Hadir: [22, 163, 74], // green-600
                                    Sakit: [202, 138, 4], // yellow-500
                                    Izin: [14, 165, 233], // sky-500
                                    Alpa: [220, 38, 38], // red-600
                                    Terlambat: [147, 51, 234] // purple-600
                                };
                                if (colorMap[status]) {
                                    data.cell.styles.fillColor = colorMap[status];
                                    data.cell.styles.textColor = [255, 255, 255];
                                    data.cell.styles.fontStyle = 'bold';
                                }
                            }
                        }
                    });
                } else {
                    doc.text('Tidak ada rincian data kehadiran pada periode ini.', 14, 80);
                }

                doc.save(`Kartu_Kehadiran_${studentData.nama}.pdf`);
            } catch (error) {
                console.error("Student Card PDF Error:", error);
                showToast("Gagal membuat PDF Kartu Siswa.", "error");
            }
        }

        function exportToExcel() {
            if (currentReportData.length === 0) return;
            const dataToExport = currentReportData.map(row => { let excelRow = { Kelas: row.kelas, NIS: row.nis, "Nama Siswa": row.nama, Hadir: row.summary.Hadir, Sakit: row.summary.Sakit, Izin: row.summary.Izin, Alpa: row.summary.Alpa, Terlambat: row.summary.Terlambat }; Object.keys(row).forEach(key => { if (key.match(/^\d{4}-\d{2}-\d{2}$/)) { excelRow[key] = row[key]; } }); return excelRow; });
            const ws = XLSX.utils.json_to_sheet(dataToExport); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Laporan Kehadiran"); XLSX.writeFile(wb, "Laporan_Kehadiran.xlsx");
        }
        
        function exportToPDF() {
            if (currentReportData.length === 0) {
                showToast('Tidak ada data untuk diekspor.', 'info');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    showToast("Pustaka PDF tidak termuat. Coba segarkan halaman.", "error");
                    return;
                }
                const doc = new jsPDF('landscape');

                // Info from UI
                const kelasText = document.getElementById('laporan-kelas-filter').options[document.getElementById('laporan-kelas-filter').selectedIndex].text;
                const startDateText = new Date(document.getElementById('laporan-start-date').value).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                const endDateText = new Date(document.getElementById('laporan-end-date').value).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                const printDate = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });

                // Header
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(reportSettings.schoolName || 'SmartPresensi', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Laporan Rekapitulasi Kehadiran Siswa', doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                doc.setLineWidth(0.5);
                doc.line(15, 25, doc.internal.pageSize.getWidth() - 15, 25);

                // Info Section
                doc.setFontSize(10);
                doc.text(`Kelas`, 15, 32);
                doc.text(`: ${kelasText}`, 40, 32);
                doc.text(`Periode`, 15, 38);
                doc.text(`: ${startDateText} s/d ${endDateText}`, 40, 38);
                doc.text(`Tanggal Cetak`, doc.internal.pageSize.getWidth() / 2, 32);
                doc.text(`: ${printDate}`, (doc.internal.pageSize.getWidth() / 2) + 25, 32);

                // Table Data Preparation
                const head = [['No', 'NIS', 'Nama Siswa', 'Hadir', 'Sakit', 'Izin', 'Alpa', 'Terlambat', 'Total']];
                let totals = { hadir: 0, sakit: 0, izin: 0, alpa: 0, terlambat: 0 };
                
                const body = currentReportData.map((row, index) => {
                    const totalDays = row.summary.Hadir + row.summary.Sakit + row.summary.Izin + row.summary.Alpa + row.summary.Terlambat;
                    totals.hadir += row.summary.Hadir;
                    totals.sakit += row.summary.Sakit;
                    totals.izin += row.summary.Izin;
                    totals.alpa += row.summary.Alpa;
                    totals.terlambat += row.summary.Terlambat;
                    
                    return [
                        index + 1,
                        row.nis,
                        row.nama,
                        row.summary.Hadir,
                        row.summary.Sakit,
                        row.summary.Izin,
                        row.summary.Alpa,
                        row.summary.Terlambat,
                        totalDays
                    ];
                });

                body.push([
                    { content: 'TOTAL', colSpan: 3, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: totals.hadir, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: totals.sakit, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: totals.izin, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: totals.alpa, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: totals.terlambat, styles: { halign: 'center', fontStyle: 'bold' } },
                    { content: '', styles: { halign: 'center' } }
                ]);

                // Generate Table
                doc.autoTable({
                    startY: 45,
                    head: head,
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 41, 59], textColor: [226, 232, 240], halign: 'center' },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 10 }, 2: { cellWidth: 'auto' },
                        3: { halign: 'center', cellWidth: 15 }, 4: { halign: 'center', cellWidth: 15 },
                        5: { halign: 'center', cellWidth: 15 }, 6: { halign: 'center', cellWidth: 15 },
                        7: { halign: 'center', cellWidth: 18 }, 8: { halign: 'center', cellWidth: 15 },
                    },
                    didDrawPage: function (data) {
                        const pageHeight = doc.internal.pageSize.getHeight();
                        doc.setFontSize(8);
                        doc.text(`Laporan dihasilkan oleh SmartPresensi`, 15, pageHeight - 10);
                        doc.text(`Halaman ${doc.internal.getNumberOfPages()}`, doc.internal.pageSize.getWidth() - 25, pageHeight - 10);
                    }
                });

                // Endorsement Section
                let finalY = doc.autoTable.previous.finalY;
                const pageHeight = doc.internal.pageSize.getHeight();
                let signY = finalY + 15;
                
                if (signY > pageHeight - 45) {
                    doc.addPage();
                    signY = 20;
                }
                
                const endorsementTextX = doc.internal.pageSize.getWidth() - 70;
                doc.setFontSize(10);
                doc.text(reportSettings.endorsementPlace || `Makassar, ${printDate}`, endorsementTextX, signY);
                doc.text('Guru / Wali Kelas,', endorsementTextX, signY + 7);
                
                doc.setFont('helvetica', 'bold');
                doc.text(reportSettings.teacherName || '(___________________)', endorsementTextX, signY + 30);
                doc.setFont('helvetica', 'normal');
                doc.text(`NIP: ${reportSettings.nip || '................................'}`, endorsementTextX, signY + 35);

                doc.save(`Laporan_Rekap_Kehadiran_${kelasText}_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (error) {
                console.error("PDF Export Error:", error);
                showToast("Gagal membuat laporan PDF. Silakan coba lagi.", "error");
            }
        }
        function displayTopStudentsReport(reportData) {
            const container = document.getElementById('top-students-report');
            if (!reportData || reportData.length === 0) {
                container.innerHTML = '';
                return;
            }
            const topHadir = [...reportData].sort((a, b) => b.summary.Hadir - a.summary.Hadir).slice(0, 5);
            const topAlpa = [...reportData].sort((a, b) => b.summary.Alpa - a.summary.Alpa).filter(s => s.summary.Alpa > 0).slice(0, 5);

            container.innerHTML = `
                <div class="border border-slate-700 rounded-lg p-4 glass-card">
                    <h4 class="font-semibold text-white mb-3">Top 5 Siswa Paling Sering Hadir</h4>
                    <ul class="space-y-2">
                        ${topHadir.map(s => `<li class="text-sm flex justify-between text-slate-300"><span>${s.nama} <span class="text-slate-500">(${s.kelas})</span></span> <span class="font-bold text-green-400">${s.summary.Hadir} hari</span></li>`).join('')}
                    </ul>
                </div>
                <div class="border border-slate-700 rounded-lg p-4 glass-card">
                    <h4 class="font-semibold text-white mb-3">Top 5 Siswa Paling Sering Alpa</h4>
                    ${topAlpa.length > 0 ? `<ul class="space-y-2">
                        ${topAlpa.map(s => `<li class="text-sm flex justify-between text-slate-300"><span>${s.nama} <span class="text-slate-500">(${s.kelas})</span></span> <span class="font-bold text-red-400">${s.summary.Alpa} hari</span></li>`).join('')}
                    </ul>` : `<p class="text-sm text-slate-400">Tidak ada siswa yang alpa pada periode ini.</p>`}
                </div>
            `;
        }
        
        // --- ADMIN SETTINGS FUNCTIONS ---
        function saveReportSettings(e) {
            e.preventDefault();
            reportSettings.schoolName = document.getElementById('setting-school-name').value;
            reportSettings.teacherName = document.getElementById('setting-teacher-name').value;
            reportSettings.nip = document.getElementById('setting-nip').value;
            reportSettings.endorsementPlace = document.getElementById('setting-endorsement-place').value;
            saveDataToStorage();
            showToast('Pengaturan laporan berhasil disimpan.', 'success');
        }

        function loadReportSettings() {
            document.getElementById('setting-school-name').value = reportSettings.schoolName || '';
            document.getElementById('setting-teacher-name').value = reportSettings.teacherName || '';
            document.getElementById('setting-nip').value = reportSettings.nip || '';
            document.getElementById('setting-endorsement-place').value = reportSettings.endorsementPlace || '';
        }

        function backupData() {
            const dataToBackup = { users, students, attendanceData, auditLog, reportSettings };
            const dataStr = JSON.stringify(dataToBackup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.download = `smartpresensi_backup_${date}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            showToast('Backup data berhasil diunduh.');
        }

        function restoreData(event) {
            const file = event.target.files[0]; if (!file) return;
            if (!confirm('Anda yakin ingin me-restore data? Semua data saat ini akan ditimpa.')) {
                event.target.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    if (restoredData.users && restoredData.students && restoredData.attendanceData) {
                        users = restoredData.users;
                        students = restoredData.students;
                        attendanceData = restoredData.attendanceData;
                        auditLog = restoredData.auditLog || {};
                        reportSettings = restoredData.reportSettings || { schoolName: '', teacherName: '', nip: '', endorsementPlace: '' };
                        saveDataToStorage();
                        showToast('Data berhasil di-restore. Aplikasi akan dimuat ulang.');
                        setTimeout(() => location.reload(), 1500);
                    } else { alert('File backup tidak valid atau rusak.'); }
                } catch (error) { alert('Gagal membaca file backup.'); console.error("Restore error:", error);
                } finally { event.target.value = ''; }
            };
            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm('PERINGATAN: Anda akan menghapus SEMUA data. Hanya akun admin default yang akan tersisa. Lanjutkan?')) {
                localStorage.removeItem(APP_DATA_KEY);
                showToast('Semua data telah dihapus. Aplikasi akan dimuat ulang.');
                setTimeout(() => location.reload(), 1500);
            }
        }
        
        function openUserModal() { 
            document.getElementById('user-management-modal').classList.add('flex');
            clearUserForm();
            renderUserList();
        }
        function renderUserList() {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = Object.entries(users).map(([username, user]) => `
                <tr class="hover:bg-slate-700/50">
                    <td class="px-4 py-2 text-sm text-slate-300">${username}</td>
                    <td class="px-4 py-2 text-sm text-slate-300">${user.name}</td>
                    <td class="px-4 py-2 text-sm text-slate-300">${user.gender === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                    <td class="px-4 py-2 text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role==='admin'?'bg-red-500/20 text-red-300':user.role==='guru'?'bg-sky-500/20 text-sky-300':'bg-green-500/20 text-green-300'}">${user.role}</span></td>
                    <td class="px-4 py-2 text-sm flex space-x-2"><button onclick="editUser('${username}')" class="text-cyan-400 hover:underline">Edit</button>${username !== 'admin' ? `<button onclick="deleteUser('${username}')" class="text-red-400 hover:underline">Hapus</button>` : ''}</td>
                </tr>
            `).join('');
        }
        function handleUserForm(e) {
            e.preventDefault();
            const originalUsername = document.getElementById('original-username').value;
            const username = document.getElementById('user-username').value;
            const role = document.getElementById('user-role-select').value;
            const password = document.getElementById('user-password').value;
            
            if (originalUsername && originalUsername !== username) {
                if (users[username]) { alert('Username sudah ada!'); return; }
                delete users[originalUsername];
            } else if (!originalUsername && users[username]) {
                alert('Username sudah ada!'); return;
            }

            if (!password && !originalUsername) {
                alert('Password wajib diisi untuk pengguna baru.');
                return;
            }

            const oldUser = users[originalUsername] || {};
            users[username] = {
                pass: password ? password : oldUser.pass,
                name: document.getElementById('user-fullname').value,
                gender: document.getElementById('user-gender').value,
                role: role,
            };
            
            showToast(`Pengguna ${username} berhasil disimpan.`, 'success');
            renderUserList();
            clearUserForm();
            saveDataToStorage();
        }
        function editUser(username) {
            const user = users[username];
            document.getElementById('user-form-title').textContent = "Edit Pengguna";
            document.getElementById('original-username').value = username;
            document.getElementById('user-username').value = username;
            document.getElementById('user-username').disabled = username === 'admin';
            document.getElementById('user-fullname').value = user.name;
            document.getElementById('user-password').required = false;
            document.getElementById('user-password').placeholder = "Kosongkan jika tidak diubah";
            document.getElementById('user-gender').value = user.gender || 'L';
            document.getElementById('user-role-select').value = user.role;
            toggleSiswaFields();
        }
        function deleteUser(username) {
            if(username === currentUser.username) { alert("Anda tidak dapat menghapus akun Anda sendiri."); return; }
            if(confirm(`Yakin ingin menghapus pengguna ${username}?`)) {
                delete users[username];
                showToast(`Pengguna ${username} telah dihapus.`);
                renderUserList();
                saveDataToStorage();
            }
        }
        function clearUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-form-title').textContent = "Tambah Pengguna Baru";
            document.getElementById('original-username').value = '';
            document.getElementById('user-username').disabled = false;
            document.getElementById('user-password').required = true;
            document.getElementById('user-password').placeholder = "";
            toggleSiswaFields();
        }
        function toggleSiswaFields() {
            document.getElementById('siswa-fields').classList.toggle('hidden', document.getElementById('user-role-select').value !== 'siswa');
        }
        let selectedClassForStudentManagement = null;
        function openClassModal() {
            document.getElementById('class-management-modal').classList.add('flex');
            renderClassList();
            viewStudentsInClass(Object.keys(students)[0]);
        }
        function renderClassList() {
            const container = document.getElementById('class-list');
            container.innerHTML = Object.keys(students).sort().map(name => `
                <div id="class-item-${name}" class="p-2 border border-slate-700 rounded-md flex justify-between items-center cursor-pointer hover:bg-slate-700/50" onclick="viewStudentsInClass('${name}')">
                    <span class="text-slate-300 font-medium">${name}</span>
                    <div class="flex items-center space-x-3">
                        <button onclick="event.stopPropagation(); editClass('${name}')" class="text-cyan-400 hover:text-cyan-300 text-xs font-semibold">Edit</button>
                        <button onclick="event.stopPropagation(); deleteClass('${name}')" class="text-red-400 hover:text-red-300 text-xs font-semibold">Hapus</button>
                    </div>
                </div>
            `).join('');
        }
        function handleClassForm(e) {
            e.preventDefault();
            const input = document.getElementById('class-name-input');
            const className = input.value.trim().toUpperCase();
            if (className && !students[className]) {
                students[className] = [];
                renderClassList();
                updateClassDropdowns();
                saveDataToStorage();
                showToast(`Kelas ${className} berhasil ditambahkan.`);
                input.value = '';
            } else if(students[className]){ alert('Nama kelas sudah ada!'); }
        }
        function editClass(oldClassName) {
            const newClassName = prompt(`Edit nama kelas "${oldClassName}":`, oldClassName)?.trim().toUpperCase();

            if (!newClassName || newClassName === oldClassName) {
                return; // User cancelled or entered the same name
            }

            if (students[newClassName]) {
                alert(`Nama kelas "${newClassName}" sudah ada. Silakan gunakan nama lain.`);
                return;
            }

            // Move students to the new class name key and delete the old one
            students[newClassName] = students[oldClassName];
            delete students[oldClassName];

            saveDataToStorage();
            showToast(`Kelas "${oldClassName}" diubah menjadi "${newClassName}".`);

            renderClassList();
            updateClassDropdowns();

            // If the edited class was being viewed, update the view to the new name
            if (selectedClassForStudentManagement === oldClassName) {
                viewStudentsInClass(newClassName);
            }
        }
        function deleteClass(className) {
            if(confirm(`Yakin ingin menghapus kelas ${className}? Semua data siswa di kelas ini juga akan terhapus.`)) {
                const studentsInClass = students[className] || [];
                // Remove associated student user accounts
                studentsInClass.forEach(student => {
                    if (users[student.nis]) {
                        delete users[student.nis];
                    }
                });
                
                delete students[className];
                renderClassList(); 
                updateClassDropdowns();
                // If the deleted class was being viewed, view the first available class or null
                viewStudentsInClass(Object.keys(students)[0] || null);
                saveDataToStorage(); 
                showToast(`Kelas ${className} dan semua siswanya telah dihapus.`);
            }
        }
        function viewStudentsInClass(className) {
            document.querySelectorAll('#class-list > div').forEach(el => el.classList.remove('bg-cyan-500/20', 'border-cyan-400'));
            if (className) {
                const el = document.getElementById(`class-item-${className}`);
                if (el) el.classList.add('bg-cyan-500/20', 'border-cyan-400');
            }
            selectedClassForStudentManagement = className;
            if(!className) {
                 document.getElementById('selected-class-name').textContent = 'Tidak Ada';
                 document.getElementById('student-in-class-tbody').innerHTML = '<tr><td colspan="4" class="text-center p-4 text-slate-400">Pilih atau buat kelas.</td></tr>';
                return;
            }
            document.getElementById('selected-class-name').textContent = className;
            const studentList = students[className] || [];
            const tbody = document.getElementById('student-in-class-tbody');
            tbody.innerHTML = studentList.length > 0 ? studentList.map(s => `
                <tr class="hover:bg-slate-700/50">
                    <td class="px-4 py-2 text-sm text-slate-300">${s.nis}</td>
                    <td class="px-4 py-2 text-sm text-slate-300">${s.name}</td>
                    <td class="px-4 py-2 text-sm text-slate-300">${s.gender === 'L' ? 'L' : 'P'}</td>
                    <td class="px-4 py-2 text-sm flex space-x-2"><button onclick="editStudent('${className}', '${s.nis}')" class="text-cyan-400 hover:underline">Edit</button><button onclick="deleteStudent('${className}', '${s.nis}')" class="text-red-400 hover:underline">Hapus</button></td>
                </tr>
            `).join('') : `<tr><td colspan="4" class="text-center p-4 text-slate-400">Belum ada siswa di kelas ini.</td></tr>`;
        }
        function handleStudentForm(e) {
            e.preventDefault();
            const nis = document.getElementById('student-nis-input').value;
            const name = document.getElementById('student-name-input').value;
            const gender = document.getElementById('student-gender-input').value;
            const editNis = document.getElementById('edit-student-nis').value;
            const classStudents = students[selectedClassForStudentManagement];
            
            const isNisExistInOtherClass = Object.entries(students).some(([kelas, list]) => kelas !== selectedClassForStudentManagement && list.some(s => s.nis === nis && s.nis !== editNis));
            if(isNisExistInOtherClass) { alert('NIS sudah terdaftar di kelas lain.'); return; }
            
            if (editNis) {
                const student = classStudents.find(s => s.nis === editNis);
                if(student) { student.nis = nis; student.name = name; student.gender = gender; }
            } else {
                if (classStudents.some(s => s.nis === nis)) { alert('NIS sudah terdaftar di kelas ini.'); return; }
                classStudents.push({ nis, name, gender });
                users[nis] = { pass: nis, role: 'siswa', name: name, gender: gender };
            }
            viewStudentsInClass(selectedClassForStudentManagement);
            toggleStudentForm(false); saveDataToStorage(); showToast(`Siswa ${name} berhasil disimpan.`);
        }
        function editStudent(className, nis) {
            const student = students[className].find(s => s.nis === nis);
            toggleStudentForm(true);
            document.getElementById('edit-student-nis').value = nis;
            document.getElementById('student-nis-input').value = student.nis;
            document.getElementById('student-name-input').value = student.name;
            document.getElementById('student-gender-input').value = student.gender || 'L';
        }
        function deleteStudent(className, nis) {
            if(confirm('Yakin ingin menghapus siswa ini?')) {
                students[className] = students[className].filter(s => s.nis !== nis);
                delete users[nis];
                viewStudentsInClass(className);
                saveDataToStorage(); showToast('Siswa berhasil dihapus.');
            }
        }
        function toggleStudentForm(show) {
            document.getElementById('add-student-form-container').classList.toggle('hidden', !show);
            if(show) {
                document.getElementById('add-student-form').reset();
                document.getElementById('edit-student-nis').value = '';
            }
        }
        function handleExcelImport() {
            if (!selectedClassForStudentManagement) { alert("Silakan pilih kelas terlebih dahulu."); return; }
            document.getElementById('excel-file-input').click();
        }
        function processExcelFile(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    if (json.length > 0 && (!json[0].hasOwnProperty('NIS') || !json[0].hasOwnProperty('Nama'))) {
                        alert('Format Excel salah. Pastikan ada kolom "NIS" dan "Nama".'); return;
                    }
                    let addedCount = 0, duplicateCount = 0;
                    const classStudents = students[selectedClassForStudentManagement];
                    const existingNis = new Set(classStudents.map(s => String(s.nis)));
                    json.forEach(row => {
                        const nis = row.NIS ? String(row.NIS).trim() : null;
                        const name = row.Nama ? String(row.Nama).trim() : null;
                        let gender = row.Gender ? String(row.Gender).trim().toUpperCase() : 'L';
                        if (gender !== 'L' && gender !== 'P') gender = 'L';
                        if (nis && name) {
                            if (existingNis.has(nis) || Object.values(students).flat().some(s=>s.nis === nis)) { duplicateCount++;
                            } else {
                                classStudents.push({ nis, name, gender }); existingNis.add(nis);
                                users[nis] = { pass: nis, role: 'siswa', name: name, gender: gender };
                                addedCount++;
                            }
                        }
                    });
                    viewStudentsInClass(selectedClassForStudentManagement); saveDataToStorage();
                    showToast(`${addedCount} siswa ditambahkan, ${duplicateCount} duplikat diabaikan.`);
                } catch (error) { console.error("Error Excel:", error); alert("Gagal memproses file.");
                } finally { event.target.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        }
        function updateClassDropdowns() {
            const classNames = Object.keys(students).sort();
            const options = classNames.map(name => `<option value="${name}">${name}</option>`).join('');
            const kelasFilter = document.getElementById('kelas-filter'); if (kelasFilter) kelasFilter.innerHTML = options;
            const laporanKelasFilter = document.getElementById('laporan-kelas-filter');
            if(laporanKelasFilter) laporanKelasFilter.innerHTML = `<option value="all">Semua Kelas</option>${options}`;
            if (classNames.length > 0) {
                selectedKelas = classNames[0];
                if (kelasFilter) kelasFilter.value = selectedKelas;
            }
        }
        
        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage();
            injectHTMLContent();
            setupEventListeners();
            updateClassDropdowns();
            document.getElementById('tanggal-filter').value = selectedTanggal;
        });
    </script>
</body>
</html>


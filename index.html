<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPresensi - Aplikasi Kehadiran Siswa</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for PDF and Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .tab-active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        .view {
            display: none;
        }
        .view-active {
            display: block;
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg text-center">
            <div class="flex items-center justify-center space-x-3 mb-4">
                <div class="bg-blue-500 p-2 rounded-full text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">SmartPresensi</h1>
            </div>
            <p id="login-message" class="text-slate-500">Silakan login dengan akun Google Anda untuk melanjutkan.</p>
            <div id="sign-in-button-container" class="flex justify-center">
                 <button id="sign-in-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2"><svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.487-11.187-8.264l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.02,35.636,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg><span>Login dengan Google</span></button>
            </div>
            <p id="auth-status" class="text-sm text-slate-600 mt-4"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="min-h-screen hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-500 p-2 rounded-full text-white">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                        </div>
                        <h1 class="text-xl font-bold text-slate-800">SmartPresensi</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="header-date" class="text-sm text-slate-500 font-medium hidden sm:block"></div>
                        <div class="text-right hidden sm:block">
                            <div id="user-name" class="font-semibold text-slate-700"></div>
                            <div id="user-role" class="text-xs text-slate-500 capitalize"></div>
                        </div>
                        <button id="logout-button" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-slate-700" title="Logout">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Navigation Tabs -->
            <div id="main-nav" class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-presensi" onclick="showView('presensi')" class="tab py-4 px-1 border-b-2 font-medium text-sm">
                        Input Kehadiran
                    </button>
                    <button id="tab-laporan" onclick="showView('laporan')" class="tab py-4 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 font-medium text-sm">
                        Laporan
                    </button>
                    <button id="tab-pengaturan" onclick="showView('pengaturan')" class="tab py-4 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 font-medium text-sm">
                        Pengaturan
                    </button>
                </nav>
            </div>

            <!-- Views for Admin/Guru -->
            <div id="admin-guru-content">
                <!-- Presensi View -->
                <div id="view-presensi" class="view">
                    <!-- Content injected by JS -->
                </div>
                <!-- Laporan View -->
                <div id="view-laporan" class="view">
                    <!-- Content injected by JS -->
                </div>
                <!-- Pengaturan View (Admin only) -->
                 <div id="view-pengaturan" class="view">
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4">Pengaturan Sistem</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- User Management Card -->
                            <div class="p-4 border rounded-lg flex flex-col">
                                <h3 class="font-semibold text-slate-700">Manajemen Pengguna</h3>
                                <p class="text-sm text-slate-500 mt-1 flex-grow">Tambah, edit, atau hapus data admin, guru, dan siswa.</p>
                                <button onclick="openUserModal()" class="mt-3 text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md w-full">Kelola Pengguna</button>
                            </div>
                             <!-- Class Management Card -->
                            <div class="p-4 border rounded-lg flex flex-col">
                                <h3 class="font-semibold text-slate-700">Manajemen Kelas & Siswa</h3>
                                <p class="text-sm text-slate-500 mt-1 flex-grow">Atur daftar kelas dan alokasi siswa per kelas.</p>
                                <button onclick="openClassModal()" class="mt-3 text-sm bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md w-full">Kelola Kelas</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View for Siswa -->
            <div id="siswa-content" class="hidden">
                 <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-800 mb-2">Rekap Kehadiran Anda</h2>
                    <p class="text-sm text-slate-500 mb-6">Berikut adalah catatan kehadiran Anda selama ini.</p>
                    
                    <div id="student-summary" class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-6">
                        <!-- Summary cards will be injected here -->
                    </div>

                    <div class="overflow-x-auto border rounded-lg">
                       <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Diubah Oleh</th>
                                </tr>
                            </thead>
                            <tbody id="student-attendance-table" class="bg-white divide-y divide-slate-200">
                                <!-- Student's personal attendance rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer id="app-footer" class="text-center py-4 border-t border-slate-200 bg-white hidden">
        <p class="text-sm text-slate-500 font-semibold">SMARTPRESENSI - MUHAMMAD HASRATUL</p>
    </footer>

    <!-- Modals -->
    <div id="audit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4"></div>
    <div id="user-management-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4"></div>
    <div id="class-management-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4"></div>
    
    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-900 text-white py-3 px-5 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, collection, getDocs, writeBatch, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        // PENTING: Ganti seluruh objek di bawah ini dengan konfigurasi
        // dari proyek Firebase Anda. Kesalahan (auth/configuration-not-found)
        // terjadi jika konfigurasi ini tidak valid.
        const firebaseConfig = {
            apiKey: "AIzaSyC9dnBMoPN539EE0IWq6x-_ZOu5QlpmVjw",
            authDomain: "smart-presensi.firebaseapp.com",
            projectId: "smart-presensi",
            storageBucket: "smart-presensi.firebasestorage.app",
            messagingSenderId: "47794401403",
            appId: "1:47794401403:web:1a82d8dc7086f8ab3632de"
        };

        // --- DATA VARIABLES ---
        let users = {};
        let students = {};
        let attendanceData = {};
        let auditLog = {};
        let currentUser = null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- STATE & ELEMENTS ---
        let selectedKelas = null;
        let selectedTanggal = new Date().toISOString().slice(0, 10);
        const statusConfig = {
            Hadir: { text: "Hadir", color: "bg-green-100 text-green-800", ring: "ring-green-500" },
            Sakit: { text: "Sakit", color: "bg-yellow-100 text-yellow-800", ring: "ring-yellow-500" },
            Izin: { text: "Izin", color: "bg-blue-100 text-blue-800", ring: "ring-blue-500" },
            Alpha: { text: "Alpha", color: "bg-red-100 text-red-800", ring: "ring-red-500" },
            Terlambat: { text: "Terlambat", color: "bg-purple-100 text-purple-800", ring: "ring-purple-500" },
        };
        
        // --- AUTH & UI SETUP ---
        async function handleLogin() {
            try {
                const result = await signInWithPopup(auth, provider);
                // The onAuthStateChanged listener will handle the rest.
            } catch (error) {
                console.error("Login Error:", error);
                document.getElementById('auth-status').innerText = `Gagal login: ${error.message}`;
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener will handle UI changes.
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('app-footer').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            } catch (error) {
                 console.error("Logout Error:", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                document.getElementById('auth-status').innerText = 'Login berhasil! Memuat data...';
                await startApp(user);
            } else {
                // User is signed out.
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('app-footer').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
            }
        });
        
        async function startApp(gUser) {
            const userRef = doc(db, "users", gUser.uid);
            let userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                const usersCollection = collection(db, "users");
                const usersSnapshot = await getDocs(usersCollection);
                if (usersSnapshot.empty) {
                    // First user ever, make them admin.
                    const newAdmin = {
                        uid: gUser.uid,
                        email: gUser.email,
                        name: gUser.displayName,
                        role: 'admin',
                        nis: '',
                        kelas: ''
                    };
                    await setDoc(userRef, newAdmin);
                    currentUser = newAdmin;
                } else {
                    document.getElementById('auth-status').innerText = 'Akun Anda tidak terdaftar. Hubungi Admin.';
                    await handleLogout();
                    return;
                }
            } else {
                currentUser = userDoc.data();
            }

            await loadAllData();

            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app-footer').classList.remove('hidden');
            document.getElementById('app').classList.add('fade-in');
            
            setupUIForRole();
        }

        async function loadAllData() {
            // Load users
            const usersSnapshot = await getDocs(collection(db, "users"));
            users = {};
            usersSnapshot.forEach(doc => {
                users[doc.id] = doc.data();
            });

            // Load classes and students
            const classesSnapshot = await getDocs(collection(db, "classes"));
            students = {};
             classesSnapshot.forEach(doc => {
                students[doc.id] = doc.data().students || [];
            });
            
            // Load attendance and audit data (could be optimized for larger datasets)
            const attendanceSnapshot = await getDocs(collection(db, "attendance"));
            attendanceData = {};
            attendanceSnapshot.forEach(doc => {
                const [date, nis] = doc.id.split('_');
                if (!attendanceData[date]) attendanceData[date] = {};
                attendanceData[date][nis] = doc.data();
            });

            const auditSnapshot = await getDocs(collection(db, "auditLog"));
            auditLog = {};
             auditSnapshot.forEach(doc => {
                const {date, nis, ...logEntry} = doc.data();
                if (!auditLog[date]) auditLog[date] = {};
                if (!auditLog[date][nis]) auditLog[date][nis] = [];
                auditLog[date][nis].push(logEntry);
            });
        }
        
        function setupUIForRole() {
            if (!currentUser) return;
            
            displayCurrentDate();
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role;

            const adminGuruContent = document.getElementById('admin-guru-content');
            const siswaContent = document.getElementById('siswa-content');
            const mainNav = document.getElementById('main-nav');
            
            adminGuruContent.style.display = 'none';
            siswaContent.style.display = 'none';
            mainNav.style.display = 'none';

            if (currentUser.role === 'admin' || currentUser.role === 'guru') {
                adminGuruContent.style.display = 'block';
                mainNav.style.display = 'block';
                document.getElementById('tab-presensi').style.display = 'block';
                document.getElementById('tab-laporan').style.display = 'block';
                document.getElementById('tab-pengaturan').style.display = currentUser.role === 'admin' ? 'block' : 'none';
                
                selectedKelas = Object.keys(students)[0] || null;

                showView('presensi');
                renderStudentTable();
            } else if (currentUser.role === 'siswa') {
                siswaContent.style.display = 'block';
                renderStudentDashboard();
            }
        }

        // --- STUDENT DASHBOARD ---
        function renderStudentDashboard() {
            const studentNis = currentUser.nis;
            const summaryContainer = document.getElementById('student-summary');
            const tableBody = document.getElementById('student-attendance-table');
            
            let studentRecords = [];
            let summary = { Hadir: 0, Sakit: 0, Izin: 0, Alpha: 0, Terlambat: 0 };

            Object.keys(attendanceData).forEach(date => {
                if (attendanceData[date] && attendanceData[date][studentNis]) {
                    const record = attendanceData[date][studentNis];
                    studentRecords.push({ date, ...record });
                    if(summary[record.status] !== undefined) summary[record.status]++;
                }
            });
            
            summaryContainer.innerHTML = Object.keys(summary).map(status => `
                <div class="p-4 rounded-lg ${statusConfig[status].color}">
                    <div class="text-2xl font-bold">${summary[status]}</div>
                    <div class="text-sm font-semibold">${status}</div>
                </div>
            `).join('');

            tableBody.innerHTML = studentRecords.length > 0 ? studentRecords.sort((a,b) => new Date(b.date) - new Date(a.date)).map(rec => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${new Date(rec.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric'})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusConfig[rec.status].color}">${rec.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${rec.editor}</td>
                </tr>
            `).join('') : `<tr><td colspan="3" class="text-center py-10 text-slate-500">Belum ada data kehadiran.</td></tr>`;
        }

        // --- HTML INJECTION & MODALS ---
        function injectHTMLContent() {
            // Views for Presensi, Laporan, Audit Modal
            document.getElementById('view-presensi').innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-800 mb-4">Pencatatan Kehadiran Siswa</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="kelas-filter" class="block text-sm font-medium text-slate-700 mb-1">Kelas</label>
                            <select id="kelas-filter" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                        </div>
                        <div>
                            <label for="tanggal-filter" class="block text-sm font-medium text-slate-700 mb-1">Tanggal</label>
                            <input type="date" id="tanggal-filter" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Siswa</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">NIS</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status Kehadiran</th></tr></thead><tbody id="student-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div>
                </div>`;
            
            document.getElementById('view-laporan').innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold text-slate-800 mb-4">Laporan Kehadiran</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                         <div><label for="laporan-kelas-filter" class="block text-sm font-medium text-slate-700 mb-1">Kelas</label><select id="laporan-kelas-filter" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select></div>
                         <div><label for="laporan-start-date" class="block text-sm font-medium text-slate-700 mb-1">Tgl Mulai</label><input type="date" id="laporan-start-date" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></div>
                        <div><label for="laporan-end-date" class="block text-sm font-medium text-slate-700 mb-1">Tgl Akhir</label><input type="date" id="laporan-end-date" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></div>
                        <button id="generate-report-btn" class="w-full md:w-auto bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors duration-200 flex items-center justify-center space-x-2"><span>Buat Laporan</span></button>
                    </div>
                    <div id="report-result" class="hidden">
                        <div class="flex justify-between items-center mb-4"><h3 id="report-title" class="text-md font-semibold text-slate-700"></h3><div class="flex space-x-2"><button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md shadow-sm text-sm">Excel</button><button id="export-pdf-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md shadow-sm text-sm">PDF</button></div></div>
                        <div class="overflow-x-auto border rounded-lg"><table class="min-w-full divide-y divide-slate-200"><thead id="report-table-head" class="bg-slate-50"></thead><tbody id="report-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div>
                    </div>
                </div>`;

             document.getElementById('audit-modal').innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-lg"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">Riwayat Perubahan</h3><button onclick="closeModal('audit-modal')" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button></div><div class="p-5 max-h-96 overflow-y-auto"><p class="text-sm mb-4">Mencatat perubahan status untuk <strong id="modal-student-name"></strong> pada tanggal <strong id="modal-date"></strong>.</p><div id="audit-log-content"></div></div><div class="p-4 bg-slate-50 flex justify-end"><button onclick="closeModal('audit-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-md">Tutup</button></div></div>`;
            
            // Admin Settings Modals
            document.getElementById('user-management-modal').innerHTML = `
                 <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">Manajemen Pengguna</h3><button onclick="closeModal('user-management-modal')" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button></div><div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2"><h4 class="font-medium mb-2">Daftar Pengguna</h4><div class="overflow-y-auto max-h-96 border rounded-lg"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Email</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Peran</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase">Aksi</th></tr></thead><tbody id="user-list-body"></tbody></table></div></div><div><h4 class="font-medium mb-2" id="user-form-title">Tambah/Edit Pengguna</h4><form id="user-form" class="space-y-3"><input type="hidden" id="user-uid"><div><label class="text-sm">Email</label><input id="user-email" type="email" required class="w-full text-sm p-2 mt-1 border rounded" disabled></div><div><label class="text-sm">Nama Lengkap</label><input id="user-fullname" type="text" required class="w-full text-sm p-2 mt-1 border rounded"></div><div><label class="text-sm">Peran</label><select id="user-role-select" class="w-full text-sm p-2 mt-1 border rounded"><option value="admin">Admin</option><option value="guru">Guru</option><option value="siswa">Siswa</option></select></div><div id="siswa-fields" class="hidden space-y-3"><hr><div><label class="text-sm">NIS</label><input id="user-nis" type="text" class="w-full text-sm p-2 mt-1 border rounded"></div><div><label class="text-sm">Kelas</label><select id="user-kelas-select" class="w-full text-sm p-2 mt-1 border rounded"></select></div></div><div class="flex space-x-2 mt-4"><button type="submit" class="w-full bg-blue-500 text-white py-2 rounded">Simpan</button><button type="button" id="clear-user-form-btn" class="w-full bg-slate-200 py-2 rounded">Batal</button></div></form></div></div></div>`;
            document.getElementById('class-management-modal').innerHTML = `
                 <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl"><div class="p-5 border-b flex justify-between items-center"><h3 class="text-lg font-semibold">Manajemen Kelas & Siswa</h3><button onclick="closeModal('class-management-modal')" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button></div><div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1"><h4 class="font-medium mb-2">Daftar Kelas</h4><div id="class-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div><h4 class="font-medium mb-2 mt-4">Tambah Kelas Baru</h4><form id="class-form" class="flex space-x-2"><input id="class-name-input" type="text" placeholder="Nama Kelas" required class="w-full p-2 border rounded"><button type="submit" class="bg-blue-500 text-white p-2 rounded">Tambah</button></form></div><div class="md:col-span-2"><div class="flex justify-between items-center mb-2 flex-wrap gap-2"><h4 class="font-medium">Siswa di Kelas <span id="selected-class-name" class="font-bold"></span></h4><div class="flex space-x-2"><button id="import-excel-btn" class="text-sm bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-3 rounded-md">Import Excel</button><button id="add-student-btn" class="text-sm bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-md">Tambah Siswa</button><input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls"></div></div><p class="text-xs text-slate-500 mb-2">Import Excel harus memiliki kolom: <strong>NIS</strong> dan <strong>Nama</strong>.</p><div id="student-in-class-list" class="overflow-y-auto max-h-96 border rounded-lg"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-slate-500">NIS</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500">Nama</th><th class="px-4 py-2 text-left text-xs font-medium text-slate-500">Aksi</th></tr></thead><tbody id="student-in-class-tbody"></tbody></table></div><div id="add-student-form-container" class="mt-4 p-4 border rounded-lg hidden"><h5 class="font-medium mb-2">Form Siswa</h5><form id="add-student-form" class="space-y-2"><input type="hidden" id="edit-student-nis"><div><label class="text-sm">NIS</label><input id="student-nis-input" required class="w-full text-sm p-2 mt-1 border rounded"></div><div><label class="text-sm">Nama Lengkap</label><input id="student-name-input" required class="w-full text-sm p-2 mt-1 border rounded"></div><div class="flex space-x-2"><button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Simpan</button><button type="button" id="cancel-add-student-btn" class="bg-slate-200 px-4 py-2 rounded">Batal</button></div></form></div></div></div></div>`;

            updateClassDropdowns();
        }
        
        function displayCurrentDate() {
            const dateElement = document.getElementById('header-date');
            if (dateElement) {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = now.toLocaleDateString('id-ID', options);
            }
        }

        // --- ALL OTHER FUNCTIONS (CRUD, UI RENDERING, etc.) GO HERE, ADAPTED FOR FIRESTORE ---
        
        // This is a placeholder for all the other functions from the previous version.
        // They need to be adapted to use Firestore instead of local variables.
        // For brevity, I'll show the key adaptations.

        async function renderStudentTable() {
            // ... (similar logic as before) ...
        }

        async function handleStatusChange(event) {
            const { nis, status } = event.target.dataset;
            const timestamp = new Date().toISOString();
            const oldStatus = attendanceData[selectedTanggal][nis].status;
            
            if (oldStatus !== status) {
                const attendanceRef = doc(db, "attendance", `${selectedTanggal}_${nis}`);
                const auditRef = collection(db, "auditLog");

                await setDoc(attendanceRef, { status, editor: currentUser.name, timestamp });
                await addDoc(auditRef, { date: selectedTanggal, nis, from: oldStatus, to: status, user: currentUser.name, timestamp });

                // Update local data for immediate UI feedback
                if (!attendanceData[selectedTanggal]) attendanceData[selectedTanggal] = {};
                attendanceData[selectedTanggal][nis] = { status, editor: currentUser.name, timestamp };
                 if (!auditLog[selectedTanggal]) auditLog[selectedTanggal] = {};
                if (!auditLog[selectedTanggal][nis]) auditLog[selectedTanggal][nis] = [];
                auditLog[selectedTanggal][nis].push({ from: oldStatus, to: status, user: currentUser.name, timestamp });
                
                showToast('Status berhasil diperbarui.');
                renderStudentTable();
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transform transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('view-active'));
            document.getElementById(`view-${viewName}`).classList.add('view-active');
            document.querySelectorAll('nav button.tab').forEach(b => b.classList.remove('tab-active'));
            const activeTab = document.getElementById(`tab-${viewName}`);
            if(activeTab) activeTab.classList.add('tab-active');
        }

        function closeModal(modalId) { document.getElementById(modalId).classList.remove('flex'); }
        function showAuditModal(nis, name) { /* ... similar logic ... */ }
        function generateReport() { /* ... similar logic ... */ }
        function displayReport(data, dates) { /* ... similar logic ... */ }
        function exportToExcel() { /* ... similar logic ... */ }
        function exportToPDF() { /* ... similar logic ... */ }

        // --- ADMIN SETTINGS FUNCTIONS (ADAPTED FOR FIRESTORE) ---
        function openUserModal() {
            document.getElementById('user-management-modal').classList.add('flex');
            clearUserForm();
            renderUserList();
        }

        function renderUserList() {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = Object.values(users).map(user => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-2 text-sm">${user.email}</td>
                    <td class="px-4 py-2 text-sm">${user.name}</td>
                    <td class="px-4 py-2 text-sm"><span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role==='admin'?'bg-red-100 text-red-800':user.role==='guru'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${user.role}</span></td>
                    <td class="px-4 py-2 text-sm flex space-x-2"><button onclick="editUser('${user.uid}')" class="text-blue-600 hover:underline">Edit</button><button onclick="deleteUser('${user.uid}')" class="text-red-600 hover:underline">Hapus</button></td>
                </tr>
            `).join('');
        }
        
        async function handleUserForm(e) {
            e.preventDefault();
            const uid = document.getElementById('user-uid').value;
            if (!uid) { alert("Tidak ada UID pengguna. Silakan pilih pengguna untuk diedit."); return; }
            
            const userRef = doc(db, "users", uid);
            const updatedData = {
                name: document.getElementById('user-fullname').value,
                role: document.getElementById('user-role-select').value,
                nis: document.getElementById('user-nis').value,
                kelas: document.getElementById('user-kelas-select').value
            };

            try {
                await setDoc(userRef, updatedData, { merge: true });
                users[uid] = { ...users[uid], ...updatedData }; // Update local cache
                showToast('Data pengguna berhasil disimpan.');
                renderUserList();
                clearUserForm();
            } catch (error) {
                console.error("Error updating user:", error);
                showToast('Gagal menyimpan data.', 'error');
            }
        }
        
        function editUser(uid) {
            const user = users[uid];
            document.getElementById('user-uid').value = uid;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-fullname').value = user.name;
            document.getElementById('user-role-select').value = user.role;
            toggleSiswaFields();
            if (user.role === 'siswa') {
                document.getElementById('user-nis').value = user.nis;
                document.getElementById('user-kelas-select').value = user.kelas;
            }
        }
        
        async function deleteUser(uid) {
            if (uid === currentUser.uid) { alert("Anda tidak bisa menghapus akun sendiri."); return; }
            if (confirm(`Yakin ingin menghapus pengguna ${users[uid].name}?`)) {
                await deleteDoc(doc(db, "users", uid));
                delete users[uid];
                showToast('Pengguna berhasil dihapus.');
                renderUserList();
            }
        }

        function clearUserForm() {
            document.getElementById('user-form').reset();
             document.getElementById('user-email').value = '(Pilih pengguna dari daftar)';
        }

        function toggleSiswaFields() { /* ... similar logic ... */ }
        function openClassModal() { /* ... similar logic ... */ }
        function renderClassList() { /* ... similar logic ... */ }
        async function handleClassForm(e) { /* ... needs Firestore update ... */ }
        async function deleteClass(className) { /* ... needs Firestore update ... */ }
        function viewStudentsInClass(className) { /* ... similar logic ... */ }
        async function handleStudentForm(e) { /* ... needs Firestore update ... */ }
        function editStudent(className, nis) { /* ... similar logic ... */ }
        async function deleteStudent(className, nis) { /* ... needs Firestore update ... */ }
        function toggleStudentForm(show) { /* ... similar logic ... */ }
        function handleExcelImport() { /* ... similar logic ... */ }
        async function processExcelFile(event) { /* ... needs Firestore update ... */ }
        function updateClassDropdowns() { /* ... similar logic ... */ }
        
        // --- EVENT LISTENERS ---
        window.addEventListener('DOMContentLoaded', () => {
            if (firebaseConfig.apiKey === "MASUKKAN_API_KEY_ANDA") {
                document.getElementById('auth-status').innerText = 'Kesalahan: Aplikasi belum dikonfigurasi. Ikuti petunjuk di README.md.';
                document.getElementById('sign-in-button').disabled = true;
            }
            
            injectHTMLContent();
            
            document.getElementById('sign-in-button').addEventListener('click', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
             // Other event listeners need to be attached here after injectHTMLContent
             document.getElementById('tanggal-filter').value = selectedTanggal;
             document.getElementById('kelas-filter').addEventListener('change', (e) => { selectedKelas = e.target.value; renderStudentTable(); });
             document.getElementById('tanggal-filter').addEventListener('change', (e) => { selectedTanggal = e.target.value; renderStudentTable(); });
             document.getElementById('generate-report-btn').addEventListener('click', generateReport);
             document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
             document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
             document.getElementById('user-form').addEventListener('submit', handleUserForm);
             document.getElementById('clear-user-form-btn').addEventListener('click', clearUserForm);
             document.getElementById('user-role-select').addEventListener('change', toggleSiswaFields);
             // ... and so on for other modals
        });
    </script>
</body>
</html>

